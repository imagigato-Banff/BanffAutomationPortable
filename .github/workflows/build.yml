name: build

on:
  workflow_dispatch:

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install npm dependencies
        run: npm install

      - name: Install R into bundle (Windows)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path app\runtime\win\R | Out-Null

          $rel = Invoke-WebRequest -UseBasicParsing -Uri "https://cran.r-project.org/bin/windows/base/release.html"
          $m = [regex]::Match($rel.Content, 'R-[0-9]+\.[0-9]+\.[0-9]+-win\.exe')
          if (!$m.Success) { Write-Host "Cannot detect R installer"; exit 1 }

          $url = "https://cran.r-project.org/bin/windows/base/" + $m.Value
          $installer = "$env:RUNNER_TEMP\" + $m.Value
          Invoke-WebRequest -Uri $url -OutFile $installer

          $dest = (Resolve-Path "app\runtime\win\R").Path
          Start-Process -FilePath $installer -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP- /DIR=`"$dest`"" -Wait

          if (!(Test-Path "app\runtime\win\R\bin\Rscript.exe")) {
            Write-Host "Rscript.exe not found after install"
            Get-ChildItem -Recurse app\runtime\win\R | Select-Object -First 80
            exit 1
          }

      - name: Install R packages into bundle (Windows)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path app\runtime\win\library | Out-Null
          $r = "app\runtime\win\R\bin\Rscript.exe"

          & $r --vanilla -e "dir.create('app/runtime/win/library', recursive=TRUE, showWarnings=FALSE);
            .libPaths('app/runtime/win/library');
            options(download.file.method='wininet');
            install.packages(c(
              'shiny','shinythemes','tidyverse','dplyr','collapsibleTree',
              'shinycssloaders','shinyWidgets','rmarkdown','knitr','readxl',
              'writexl','kableExtra','stringr','shinyjs'
            ), repos='https://cloud.r-project.org');
            cat('INSTALLED_OK\n');
            cat(paste(installed.packages()[,1], collapse=', '))"

      - name: Build Windows portable
        run: npm run build:win

      - uses: actions/upload-artifact@v4
        with:
          name: BanffAutomation-Windows
          path: dist/*

  macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install npm dependencies
        run: npm install

      - name: Build macOS dmg (no publish)
        run: npx electron-builder --mac dmg --publish never

      - uses: actions/upload-artifact@v4
        with:
          name: BanffAutomation-macOS
          path: dist/*

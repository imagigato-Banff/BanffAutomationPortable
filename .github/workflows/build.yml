name: build

on:
  workflow_dispatch:

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install npm dependencies
        run: npm install

      - name: Install R into bundle (Windows)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path app\runtime\win\R | Out-Null

          $rel = Invoke-WebRequest -UseBasicParsing -Uri "https://cran.r-project.org/bin/windows/base/release.html"
          $m = [regex]::Match($rel.Content, 'R-[0-9]+\.[0-9]+\.[0-9]+-win\.exe')
          if (!$m.Success) { Write-Host "Cannot detect R installer"; exit 1 }

          $url = "https://cran.r-project.org/bin/windows/base/" + $m.Value
          $installer = "$env:RUNNER_TEMP\" + $m.Value
          Invoke-WebRequest -Uri $url -OutFile $installer

          $dest = (Resolve-Path "app\runtime\win\R").Path
          Start-Process -FilePath $installer -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP- /DIR=`"$dest`"" -Wait

          if (!(Test-Path "app\runtime\win\R\bin\Rscript.exe")) {
            Write-Host "Rscript.exe not found after install"
            Get-ChildItem -Recurse app\runtime\win\R | Select-Object -First 80
            exit 1
          }

      - name: Install R packages into bundle (Windows)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path app\runtime\win\library | Out-Null

          @"
          dir.create('app/runtime/win/library', recursive=TRUE, showWarnings=FALSE)
          .libPaths('app/runtime/win/library')

          options(download.file.method='wininet')
          repos <- 'https://cloud.r-project.org'

          pkgs <- c(
            'shiny','httpuv','jsonlite',
            'tidyverse','dplyr','stringr',
            'readxl','writexl',
            'rmarkdown','knitr','kableExtra',
            'shinythemes','shinyWidgets','shinycssloaders','shinyjs',
            'collapsibleTree'
          )

          install.packages(pkgs, repos=repos)

          cat('INSTALLED_OK\n')
          cat('shiny=', requireNamespace('shiny', quietly=TRUE), '\n')
          cat('tidyverse=', requireNamespace('tidyverse', quietly=TRUE), '\n')
          cat('shinythemes=', requireNamespace('shinythemes', quietly=TRUE), '\n')
          cat('shinyjs=', requireNamespace('shinyjs', quietly=TRUE), '\n')
          "@ | Set-Content -Encoding UTF8 install_packages.R

          $r = "app\runtime\win\R\bin\Rscript.exe"
          & $r --vanilla install_packages.R

      - name: Build Windows portable
        run: npm run build:win

      - uses: actions/upload-artifact@v4
        with:
          name: BanffAutomation-Windows
          path: dist/*

  macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install npm dependencies
        run: npm install

      - name: Build macOS dmg (no publish)
        run: npx electron-builder --mac dmg --publish never

      - uses: actions/upload-artifact@v4
        with:
          name: BanffAutomation-macOS
          path: dist/*
